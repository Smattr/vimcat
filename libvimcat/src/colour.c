#include "colour.h"
#include <assert.h>
#include <limits.h>
#include <stdint.h>

/// Translation from 8-bit colours to 24-bit. We could do something more clever,
/// with logic to translate each regular range, but since there are only 256
/// entries it is simpler to use an explicit look up table and let the compiler
/// unroll loops that access this table.
static const colour_t LUT[] = {

    // for i in range(7):
    //   print(f"    [{i}] = {{"
    //         f".r = {'0x80' if (i & 1) else '0x00'}, "
    //         f".g = {'0x80' if ((i >> 1) & 1) else '0x00'}, "
    //         f".b = {'0x80' if ((i >> 2) & 1) else '0x00'}}},")
    [0] = {.r = 0x00, .g = 0x00, .b = 0x00},
    [1] = {.r = 0x80, .g = 0x00, .b = 0x00},
    [2] = {.r = 0x00, .g = 0x80, .b = 0x00},
    [3] = {.r = 0x80, .g = 0x80, .b = 0x00},
    [4] = {.r = 0x00, .g = 0x00, .b = 0x80},
    [5] = {.r = 0x80, .g = 0x00, .b = 0x80},
    [6] = {.r = 0x00, .g = 0x80, .b = 0x80},

    [7] = {.r = 0xc0, .g = 0xc0, .b = 0xc0},
    [8] = {.r = 0x80, .g = 0x80, .b = 0x80},

    // for i in range(9, 16):
    //   print(f"    [{i}] = {{"
    //         f".r = {'0xff' if ((i - 8) & 1) else '0x00'}, "
    //         f".g = {'0xff' if (((i - 8) >> 1) & 1) else '0x00'}, "
    //         f".b = {'0xff' if (((i - 8) >> 2) & 1) else '0x00'}}},")
    [9] = {.r = 0xff, .g = 0x00, .b = 0x00},
    [10] = {.r = 0x00, .g = 0xff, .b = 0x00},
    [11] = {.r = 0xff, .g = 0xff, .b = 0x00},
    [12] = {.r = 0x00, .g = 0x00, .b = 0xff},
    [13] = {.r = 0xff, .g = 0x00, .b = 0xff},
    [14] = {.r = 0x00, .g = 0xff, .b = 0xff},
    [15] = {.r = 0xff, .g = 0xff, .b = 0xff},

    // clang-format off
    // for i in range(16, 232):
    //   print(f"    [{i}] = {{"
    //         f".r = 0x{0 if (i - 16) // 6 // 6 % 6 == 0 else 0xff - (5 - (i - 16) // 6 // 6 % 6) * 40:02x}, "
    //         f".g = 0x{0 if (i - 16) // 6 % 6 == 0 else 0xff - (5 - (i - 16) // 6 % 6) * 40:02x}, "
    //         f".b = 0x{0 if (i - 16) % 6 == 0 else 0xff - (5 - ((i - 16) % 6)) * 40:02x}}},")
    // clang-format on
    [16] = {.r = 0x00, .g = 0x00, .b = 0x00},
    [17] = {.r = 0x00, .g = 0x00, .b = 0x5f},
    [18] = {.r = 0x00, .g = 0x00, .b = 0x87},
    [19] = {.r = 0x00, .g = 0x00, .b = 0xaf},
    [20] = {.r = 0x00, .g = 0x00, .b = 0xd7},
    [21] = {.r = 0x00, .g = 0x00, .b = 0xff},
    [22] = {.r = 0x00, .g = 0x5f, .b = 0x00},
    [23] = {.r = 0x00, .g = 0x5f, .b = 0x5f},
    [24] = {.r = 0x00, .g = 0x5f, .b = 0x87},
    [25] = {.r = 0x00, .g = 0x5f, .b = 0xaf},
    [26] = {.r = 0x00, .g = 0x5f, .b = 0xd7},
    [27] = {.r = 0x00, .g = 0x5f, .b = 0xff},
    [28] = {.r = 0x00, .g = 0x87, .b = 0x00},
    [29] = {.r = 0x00, .g = 0x87, .b = 0x5f},
    [30] = {.r = 0x00, .g = 0x87, .b = 0x87},
    [31] = {.r = 0x00, .g = 0x87, .b = 0xaf},
    [32] = {.r = 0x00, .g = 0x87, .b = 0xd7},
    [33] = {.r = 0x00, .g = 0x87, .b = 0xff},
    [34] = {.r = 0x00, .g = 0xaf, .b = 0x00},
    [35] = {.r = 0x00, .g = 0xaf, .b = 0x5f},
    [36] = {.r = 0x00, .g = 0xaf, .b = 0x87},
    [37] = {.r = 0x00, .g = 0xaf, .b = 0xaf},
    [38] = {.r = 0x00, .g = 0xaf, .b = 0xd7},
    [39] = {.r = 0x00, .g = 0xaf, .b = 0xff},
    [40] = {.r = 0x00, .g = 0xd7, .b = 0x00},
    [41] = {.r = 0x00, .g = 0xd7, .b = 0x5f},
    [42] = {.r = 0x00, .g = 0xd7, .b = 0x87},
    [43] = {.r = 0x00, .g = 0xd7, .b = 0xaf},
    [44] = {.r = 0x00, .g = 0xd7, .b = 0xd7},
    [45] = {.r = 0x00, .g = 0xd7, .b = 0xff},
    [46] = {.r = 0x00, .g = 0xff, .b = 0x00},
    [47] = {.r = 0x00, .g = 0xff, .b = 0x5f},
    [48] = {.r = 0x00, .g = 0xff, .b = 0x87},
    [49] = {.r = 0x00, .g = 0xff, .b = 0xaf},
    [50] = {.r = 0x00, .g = 0xff, .b = 0xd7},
    [51] = {.r = 0x00, .g = 0xff, .b = 0xff},
    [52] = {.r = 0x5f, .g = 0x00, .b = 0x00},
    [53] = {.r = 0x5f, .g = 0x00, .b = 0x5f},
    [54] = {.r = 0x5f, .g = 0x00, .b = 0x87},
    [55] = {.r = 0x5f, .g = 0x00, .b = 0xaf},
    [56] = {.r = 0x5f, .g = 0x00, .b = 0xd7},
    [57] = {.r = 0x5f, .g = 0x00, .b = 0xff},
    [58] = {.r = 0x5f, .g = 0x5f, .b = 0x00},
    [59] = {.r = 0x5f, .g = 0x5f, .b = 0x5f},
    [60] = {.r = 0x5f, .g = 0x5f, .b = 0x87},
    [61] = {.r = 0x5f, .g = 0x5f, .b = 0xaf},
    [62] = {.r = 0x5f, .g = 0x5f, .b = 0xd7},
    [63] = {.r = 0x5f, .g = 0x5f, .b = 0xff},
    [64] = {.r = 0x5f, .g = 0x87, .b = 0x00},
    [65] = {.r = 0x5f, .g = 0x87, .b = 0x5f},
    [66] = {.r = 0x5f, .g = 0x87, .b = 0x87},
    [67] = {.r = 0x5f, .g = 0x87, .b = 0xaf},
    [68] = {.r = 0x5f, .g = 0x87, .b = 0xd7},
    [69] = {.r = 0x5f, .g = 0x87, .b = 0xff},
    [70] = {.r = 0x5f, .g = 0xaf, .b = 0x00},
    [71] = {.r = 0x5f, .g = 0xaf, .b = 0x5f},
    [72] = {.r = 0x5f, .g = 0xaf, .b = 0x87},
    [73] = {.r = 0x5f, .g = 0xaf, .b = 0xaf},
    [74] = {.r = 0x5f, .g = 0xaf, .b = 0xd7},
    [75] = {.r = 0x5f, .g = 0xaf, .b = 0xff},
    [76] = {.r = 0x5f, .g = 0xd7, .b = 0x00},
    [77] = {.r = 0x5f, .g = 0xd7, .b = 0x5f},
    [78] = {.r = 0x5f, .g = 0xd7, .b = 0x87},
    [79] = {.r = 0x5f, .g = 0xd7, .b = 0xaf},
    [80] = {.r = 0x5f, .g = 0xd7, .b = 0xd7},
    [81] = {.r = 0x5f, .g = 0xd7, .b = 0xff},
    [82] = {.r = 0x5f, .g = 0xff, .b = 0x00},
    [83] = {.r = 0x5f, .g = 0xff, .b = 0x5f},
    [84] = {.r = 0x5f, .g = 0xff, .b = 0x87},
    [85] = {.r = 0x5f, .g = 0xff, .b = 0xaf},
    [86] = {.r = 0x5f, .g = 0xff, .b = 0xd7},
    [87] = {.r = 0x5f, .g = 0xff, .b = 0xff},
    [88] = {.r = 0x87, .g = 0x00, .b = 0x00},
    [89] = {.r = 0x87, .g = 0x00, .b = 0x5f},
    [90] = {.r = 0x87, .g = 0x00, .b = 0x87},
    [91] = {.r = 0x87, .g = 0x00, .b = 0xaf},
    [92] = {.r = 0x87, .g = 0x00, .b = 0xd7},
    [93] = {.r = 0x87, .g = 0x00, .b = 0xff},
    [94] = {.r = 0x87, .g = 0x5f, .b = 0x00},
    [95] = {.r = 0x87, .g = 0x5f, .b = 0x5f},
    [96] = {.r = 0x87, .g = 0x5f, .b = 0x87},
    [97] = {.r = 0x87, .g = 0x5f, .b = 0xaf},
    [98] = {.r = 0x87, .g = 0x5f, .b = 0xd7},
    [99] = {.r = 0x87, .g = 0x5f, .b = 0xff},
    [100] = {.r = 0x87, .g = 0x87, .b = 0x00},
    [101] = {.r = 0x87, .g = 0x87, .b = 0x5f},
    [102] = {.r = 0x87, .g = 0x87, .b = 0x87},
    [103] = {.r = 0x87, .g = 0x87, .b = 0xaf},
    [104] = {.r = 0x87, .g = 0x87, .b = 0xd7},
    [105] = {.r = 0x87, .g = 0x87, .b = 0xff},
    [106] = {.r = 0x87, .g = 0xaf, .b = 0x00},
    [107] = {.r = 0x87, .g = 0xaf, .b = 0x5f},
    [108] = {.r = 0x87, .g = 0xaf, .b = 0x87},
    [109] = {.r = 0x87, .g = 0xaf, .b = 0xaf},
    [110] = {.r = 0x87, .g = 0xaf, .b = 0xd7},
    [111] = {.r = 0x87, .g = 0xaf, .b = 0xff},
    [112] = {.r = 0x87, .g = 0xd7, .b = 0x00},
    [113] = {.r = 0x87, .g = 0xd7, .b = 0x5f},
    [114] = {.r = 0x87, .g = 0xd7, .b = 0x87},
    [115] = {.r = 0x87, .g = 0xd7, .b = 0xaf},
    [116] = {.r = 0x87, .g = 0xd7, .b = 0xd7},
    [117] = {.r = 0x87, .g = 0xd7, .b = 0xff},
    [118] = {.r = 0x87, .g = 0xff, .b = 0x00},
    [119] = {.r = 0x87, .g = 0xff, .b = 0x5f},
    [120] = {.r = 0x87, .g = 0xff, .b = 0x87},
    [121] = {.r = 0x87, .g = 0xff, .b = 0xaf},
    [122] = {.r = 0x87, .g = 0xff, .b = 0xd7},
    [123] = {.r = 0x87, .g = 0xff, .b = 0xff},
    [124] = {.r = 0xaf, .g = 0x00, .b = 0x00},
    [125] = {.r = 0xaf, .g = 0x00, .b = 0x5f},
    [126] = {.r = 0xaf, .g = 0x00, .b = 0x87},
    [127] = {.r = 0xaf, .g = 0x00, .b = 0xaf},
    [128] = {.r = 0xaf, .g = 0x00, .b = 0xd7},
    [129] = {.r = 0xaf, .g = 0x00, .b = 0xff},
    [130] = {.r = 0xaf, .g = 0x5f, .b = 0x00},
    [131] = {.r = 0xaf, .g = 0x5f, .b = 0x5f},
    [132] = {.r = 0xaf, .g = 0x5f, .b = 0x87},
    [133] = {.r = 0xaf, .g = 0x5f, .b = 0xaf},
    [134] = {.r = 0xaf, .g = 0x5f, .b = 0xd7},
    [135] = {.r = 0xaf, .g = 0x5f, .b = 0xff},
    [136] = {.r = 0xaf, .g = 0x87, .b = 0x00},
    [137] = {.r = 0xaf, .g = 0x87, .b = 0x5f},
    [138] = {.r = 0xaf, .g = 0x87, .b = 0x87},
    [139] = {.r = 0xaf, .g = 0x87, .b = 0xaf},
    [140] = {.r = 0xaf, .g = 0x87, .b = 0xd7},
    [141] = {.r = 0xaf, .g = 0x87, .b = 0xff},
    [142] = {.r = 0xaf, .g = 0xaf, .b = 0x00},
    [143] = {.r = 0xaf, .g = 0xaf, .b = 0x5f},
    [144] = {.r = 0xaf, .g = 0xaf, .b = 0x87},
    [145] = {.r = 0xaf, .g = 0xaf, .b = 0xaf},
    [146] = {.r = 0xaf, .g = 0xaf, .b = 0xd7},
    [147] = {.r = 0xaf, .g = 0xaf, .b = 0xff},
    [148] = {.r = 0xaf, .g = 0xd7, .b = 0x00},
    [149] = {.r = 0xaf, .g = 0xd7, .b = 0x5f},
    [150] = {.r = 0xaf, .g = 0xd7, .b = 0x87},
    [151] = {.r = 0xaf, .g = 0xd7, .b = 0xaf},
    [152] = {.r = 0xaf, .g = 0xd7, .b = 0xd7},
    [153] = {.r = 0xaf, .g = 0xd7, .b = 0xff},
    [154] = {.r = 0xaf, .g = 0xff, .b = 0x00},
    [155] = {.r = 0xaf, .g = 0xff, .b = 0x5f},
    [156] = {.r = 0xaf, .g = 0xff, .b = 0x87},
    [157] = {.r = 0xaf, .g = 0xff, .b = 0xaf},
    [158] = {.r = 0xaf, .g = 0xff, .b = 0xd7},
    [159] = {.r = 0xaf, .g = 0xff, .b = 0xff},
    [160] = {.r = 0xd7, .g = 0x00, .b = 0x00},
    [161] = {.r = 0xd7, .g = 0x00, .b = 0x5f},
    [162] = {.r = 0xd7, .g = 0x00, .b = 0x87},
    [163] = {.r = 0xd7, .g = 0x00, .b = 0xaf},
    [164] = {.r = 0xd7, .g = 0x00, .b = 0xd7},
    [165] = {.r = 0xd7, .g = 0x00, .b = 0xff},
    [166] = {.r = 0xd7, .g = 0x5f, .b = 0x00},
    [167] = {.r = 0xd7, .g = 0x5f, .b = 0x5f},
    [168] = {.r = 0xd7, .g = 0x5f, .b = 0x87},
    [169] = {.r = 0xd7, .g = 0x5f, .b = 0xaf},
    [170] = {.r = 0xd7, .g = 0x5f, .b = 0xd7},
    [171] = {.r = 0xd7, .g = 0x5f, .b = 0xff},
    [172] = {.r = 0xd7, .g = 0x87, .b = 0x00},
    [173] = {.r = 0xd7, .g = 0x87, .b = 0x5f},
    [174] = {.r = 0xd7, .g = 0x87, .b = 0x87},
    [175] = {.r = 0xd7, .g = 0x87, .b = 0xaf},
    [176] = {.r = 0xd7, .g = 0x87, .b = 0xd7},
    [177] = {.r = 0xd7, .g = 0x87, .b = 0xff},
    [178] = {.r = 0xd7, .g = 0xaf, .b = 0x00},
    [179] = {.r = 0xd7, .g = 0xaf, .b = 0x5f},
    [180] = {.r = 0xd7, .g = 0xaf, .b = 0x87},
    [181] = {.r = 0xd7, .g = 0xaf, .b = 0xaf},
    [182] = {.r = 0xd7, .g = 0xaf, .b = 0xd7},
    [183] = {.r = 0xd7, .g = 0xaf, .b = 0xff},
    [184] = {.r = 0xd7, .g = 0xd7, .b = 0x00},
    [185] = {.r = 0xd7, .g = 0xd7, .b = 0x5f},
    [186] = {.r = 0xd7, .g = 0xd7, .b = 0x87},
    [187] = {.r = 0xd7, .g = 0xd7, .b = 0xaf},
    [188] = {.r = 0xd7, .g = 0xd7, .b = 0xd7},
    [189] = {.r = 0xd7, .g = 0xd7, .b = 0xff},
    [190] = {.r = 0xd7, .g = 0xff, .b = 0x00},
    [191] = {.r = 0xd7, .g = 0xff, .b = 0x5f},
    [192] = {.r = 0xd7, .g = 0xff, .b = 0x87},
    [193] = {.r = 0xd7, .g = 0xff, .b = 0xaf},
    [194] = {.r = 0xd7, .g = 0xff, .b = 0xd7},
    [195] = {.r = 0xd7, .g = 0xff, .b = 0xff},
    [196] = {.r = 0xff, .g = 0x00, .b = 0x00},
    [197] = {.r = 0xff, .g = 0x00, .b = 0x5f},
    [198] = {.r = 0xff, .g = 0x00, .b = 0x87},
    [199] = {.r = 0xff, .g = 0x00, .b = 0xaf},
    [200] = {.r = 0xff, .g = 0x00, .b = 0xd7},
    [201] = {.r = 0xff, .g = 0x00, .b = 0xff},
    [202] = {.r = 0xff, .g = 0x5f, .b = 0x00},
    [203] = {.r = 0xff, .g = 0x5f, .b = 0x5f},
    [204] = {.r = 0xff, .g = 0x5f, .b = 0x87},
    [205] = {.r = 0xff, .g = 0x5f, .b = 0xaf},
    [206] = {.r = 0xff, .g = 0x5f, .b = 0xd7},
    [207] = {.r = 0xff, .g = 0x5f, .b = 0xff},
    [208] = {.r = 0xff, .g = 0x87, .b = 0x00},
    [209] = {.r = 0xff, .g = 0x87, .b = 0x5f},
    [210] = {.r = 0xff, .g = 0x87, .b = 0x87},
    [211] = {.r = 0xff, .g = 0x87, .b = 0xaf},
    [212] = {.r = 0xff, .g = 0x87, .b = 0xd7},
    [213] = {.r = 0xff, .g = 0x87, .b = 0xff},
    [214] = {.r = 0xff, .g = 0xaf, .b = 0x00},
    [215] = {.r = 0xff, .g = 0xaf, .b = 0x5f},
    [216] = {.r = 0xff, .g = 0xaf, .b = 0x87},
    [217] = {.r = 0xff, .g = 0xaf, .b = 0xaf},
    [218] = {.r = 0xff, .g = 0xaf, .b = 0xd7},
    [219] = {.r = 0xff, .g = 0xaf, .b = 0xff},
    [220] = {.r = 0xff, .g = 0xd7, .b = 0x00},
    [221] = {.r = 0xff, .g = 0xd7, .b = 0x5f},
    [222] = {.r = 0xff, .g = 0xd7, .b = 0x87},
    [223] = {.r = 0xff, .g = 0xd7, .b = 0xaf},
    [224] = {.r = 0xff, .g = 0xd7, .b = 0xd7},
    [225] = {.r = 0xff, .g = 0xd7, .b = 0xff},
    [226] = {.r = 0xff, .g = 0xff, .b = 0x00},
    [227] = {.r = 0xff, .g = 0xff, .b = 0x5f},
    [228] = {.r = 0xff, .g = 0xff, .b = 0x87},
    [229] = {.r = 0xff, .g = 0xff, .b = 0xaf},
    [230] = {.r = 0xff, .g = 0xff, .b = 0xd7},
    [231] = {.r = 0xff, .g = 0xff, .b = 0xff},

    // for i in range(232, 256):
    //   print(f"    [{i}] = {{"
    //         f".r = 0x{8 + (i - 232) * 10:02x}, "
    //         f".g = 0x{8 + (i - 232) * 10:02x}, "
    //         f".b = 0x{8 + (i - 232) * 10:02x}}},")
    [232] = {.r = 0x08, .g = 0x08, .b = 0x08},
    [233] = {.r = 0x12, .g = 0x12, .b = 0x12},
    [234] = {.r = 0x1c, .g = 0x1c, .b = 0x1c},
    [235] = {.r = 0x26, .g = 0x26, .b = 0x26},
    [236] = {.r = 0x30, .g = 0x30, .b = 0x30},
    [237] = {.r = 0x3a, .g = 0x3a, .b = 0x3a},
    [238] = {.r = 0x44, .g = 0x44, .b = 0x44},
    [239] = {.r = 0x4e, .g = 0x4e, .b = 0x4e},
    [240] = {.r = 0x58, .g = 0x58, .b = 0x58},
    [241] = {.r = 0x62, .g = 0x62, .b = 0x62},
    [242] = {.r = 0x6c, .g = 0x6c, .b = 0x6c},
    [243] = {.r = 0x76, .g = 0x76, .b = 0x76},
    [244] = {.r = 0x80, .g = 0x80, .b = 0x80},
    [245] = {.r = 0x8a, .g = 0x8a, .b = 0x8a},
    [246] = {.r = 0x94, .g = 0x94, .b = 0x94},
    [247] = {.r = 0x9e, .g = 0x9e, .b = 0x9e},
    [248] = {.r = 0xa8, .g = 0xa8, .b = 0xa8},
    [249] = {.r = 0xb2, .g = 0xb2, .b = 0xb2},
    [250] = {.r = 0xbc, .g = 0xbc, .b = 0xbc},
    [251] = {.r = 0xc6, .g = 0xc6, .b = 0xc6},
    [252] = {.r = 0xd0, .g = 0xd0, .b = 0xd0},
    [253] = {.r = 0xda, .g = 0xda, .b = 0xda},
    [254] = {.r = 0xe4, .g = 0xe4, .b = 0xe4},
    [255] = {.r = 0xee, .g = 0xee, .b = 0xee},
};

_Static_assert(sizeof(LUT) / sizeof(LUT[0]) == 256,
               "incorrect colour lookup table");

colour_t colour_8_to_24(uint8_t colour) { return LUT[colour]; }

unsigned colour_24_to_8(colour_t colour) {

  // search for an 8-bit colour that translates to this 24-bit one
  for (unsigned i = 0; i < 256; ++i) {
    assert(i < sizeof(LUT) / sizeof(LUT[0]));
    if (colour_eq(LUT[i], colour))
      return i;
  }

  // otherwise there is no translation
  return UINT_MAX;
}
